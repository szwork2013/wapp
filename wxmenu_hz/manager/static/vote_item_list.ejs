<% include inc/head2 %>
<% include inc/top %>
<% include inc/left %>

<div id="grid"></div>
<script id="popup_editor" type="text/x-kendo-template">
          
            <div class="k-edit-label w-800-l vote_hide">
                <label for="_id">投票id</label>
            </div>
            <div data-container-for="_id" class="k-edit-field w-800-r vote_hide"  data-bind="value:_id">
                <input type="text" class="k-input k-textbox w-50-inp" name="_id" data-bind="value:_id" readonly="readonly">
            </div>

             <div class="k-edit-label  w-800-l vote_hide">
                <label for="appId" >开发商</label>
            </div>
            <div data-container-for="appId" class="k-edit-field w-800-r vote_hide">
               <input type="text" id="appId_inp" class="k-input k-textbox w-50-inp" name="appId" data-bind="value:appId">
            </div>

            <div class="k-edit-label  w-800-l vote_hide">
                <label for="voteId" >所属投票</label>
            </div>
            <div data-container-for="voteId" class="k-edit-field w-800-r vote_hide">
               <input type="text" id="voteId_inp" class="k-input k-textbox w-50-inp" name="voteId" data-bind="value:voteId"  >
            </div>


            <div class="k-edit-label  w-800-l">
                <label for="groupId" id="groupIdText"></label>
            </div>
            <div data-container-for="groupId" class="k-edit-field w-800-r">
               <input type="text" id="groupId_inp" class="k-input k-textbox w-50-inp" name="groupId" data-bind="value:groupId" required="required" data-required-msg="">
            </div>
            
            <div class="k-edit-label  w-800-l">
                <label for="title" >名称</label>
            </div>
            <div data-container-for="title" class="k-edit-field w-800-r">
               <input type="text" id="appId_inp" class="k-input k-textbox w-50-inp" name="title" data-bind="value:title" data-required-msg="请填写标题" aria-invalid="true">
            </div>


            <div name="img_div" class="k-edit-label  w-800-l">
                <label for="pictureThumb">缩略图</label>
            </div>
            <div name="img_div" data-container-for="pictureThumb" class="k-edit-field w-800-r">
                <input type="file" name="upload_file" id="upload_file">
                 <input type="text"  class="k-input k-textbox" style="display:none;" id="appPicture_inp" name="pictureThumb" data-bind="value:pictureThumb">
            </div>

            <div name="img_div" class="k-edit-label  w-800-l">
                <label for="picture">大图</label>
            </div>
            <div name="img_div" data-container-for="picture" class="k-edit-field w-800-r">
                <input type="file" name="upload_file" id="upload_file2">
                 <input type="text"  class="k-input k-textbox" style="display:none;" id="appPicture_inp2" name="picture" data-bind="value:picture">
            </div>

            
            <div class="k-edit-label  w-800-l">
                <label for="sex" >性别</label>
            </div>
            <div data-container-for="sex" class="k-edit-field w-800-r">
               <input type="number" id="sex_inp" class="k-input k-textbox w-50-inp" name="sex" data-bind="value:sex" data-required-msg="请填写性别" aria-invalid="true">
            </div>

            <div class="k-edit-label  w-800-l vote_hide">
                <label for="age" >年龄</label>
            </div>
            <div data-container-for="age" class="k-edit-field w-800-r vote_hide">
               <input type="number" id="" class="k-input k-textbox w-50-inp" name="age" data-bind="value:age" data-required-msg="请填写年龄" aria-invalid="true">
            </div>


            <div class="k-edit-label  w-800-l vote_hide">
                <label for="number" >工号</label>
            </div>
            <div data-container-for="number" class="k-edit-field w-800-r vote_hide">
               <input type="text" id="appId_inp" class="k-input k-textbox w-50-inp" name="number" data-bind="value:number" data-required-msg="请填写年龄" aria-invalid="true">
            </div>


            <div class="k-edit-label  w-800-l">
                <label for="code2" >部门</label>
            </div>
            <div data-container-for="code2" class="k-edit-field w-800-r">
               <input type="text" class="k-input k-textbox w-50-inp" name="code2" data-bind="value:code2" >
            </div>
            <div class="k-edit-label  w-800-l">
                <label for="code3" >职务</label>
            </div>
            <div data-container-for="code3" class="k-edit-field w-800-r">
               <input type="text" class="k-input k-textbox w-50-inp" name="code3" data-bind="value:code3" >
            </div>


            <div class="k-edit-label  w-800-l">
                <label for="todayVoteNumber" >今日票数</label>
            </div>
            <div data-container-for="todayVoteNumber" class="k-edit-field w-800-r">
               <input type="number" id="appId_inp" class="k-input k-textbox w-50-inp" name="todayVoteNumber" data-bind="value:todayVoteNumber" data-required-msg="请填写年龄" aria-invalid="true">
            </div>


            <div class="k-edit-label  w-800-l">
                <label for="lastdayVoteNumber" >昨日票数</label>
            </div>
            <div data-container-for="lastdayVoteNumber" class="k-edit-field w-800-r">
               <input type="number" id="appId_inp" class="k-input k-textbox w-50-inp" name="lastdayVoteNumber" data-bind="value:lastdayVoteNumber" data-required-msg="请填写年龄" aria-invalid="true">
            </div>


            <div class="k-edit-label  w-800-l">
                <label for="lastdayVoteOrder" >昨日排名</label>
            </div>
            <div data-container-for="lastdayVoteOrder" class="k-edit-field w-800-r">
               <input type="number" id="appId_inp" class="k-input k-textbox w-50-inp" name="lastdayVoteOrder" data-bind="value:lastdayVoteOrder" data-required-msg="请填写年龄" aria-invalid="true">
            </div>



            <div class="k-edit-label  w-800-l">
                <label for="isFreez">是否冻结</label>
            </div>
            <div data-container-for="isFreez" class="k-edit-field w-800-r">
               <input type="number" id="isFreez_inp" class="k-input k-textbox" name="isFreez" data-bind="value:isFreez" >
               <span>如果被冻结，则此项无法被投票</span>
            </div>            
            

            
            <div class="k-edit-label  w-800-l vote_hide">
                <label for="code1" >作弊警告</label>
            </div>
            <div data-container-for="code1" class="k-edit-field w-800-r vote_hide">
               <input type="text" class="k-input k-textbox w-50-inp" name="code1" data-bind="value:code1" >
            </div>


           
<div style="display:none">
            <div class="k-edit-label  w-800-l">
                <label for="code4" >备用4</label>
            </div>
            <div data-container-for="code4" class="k-edit-field w-800-r">
               <input type="text" class="k-input k-textbox w-50-inp" name="code4" data-bind="value:code4" >
            </div>
</div> 


            <div class="k-edit-label  w-800-l">
                <label for="desc" >简介</label>
            </div>
            <div data-container-for="desc" class="k-edit-field w-800-r">
               <textarea id="intro" type="text" class="k-input k-textbox w-90-inp" name="desc" data-bind="value:desc"></textarea>
            </div>


            <div class="k-edit-label  w-800-l">
                <label for="desc2" >事迹</label>
            </div>
            <div data-container-for="desc2" class="k-edit-field w-800-r">
               <textarea id="intro2" type="text" class="k-input k-textbox w-90-inp" name="desc2" data-bind="value:desc2"></textarea>
            </div>



            <div class="k-edit-label  w-800-l">
                <label for="isShow">是否启用</label>
            </div>
            <div data-container-for="isShow" class="k-edit-field w-800-r">
               <input type="number" id="isShow_inp" class="k-input k-textbox" name="isShow" data-bind="value:isShow" >
            </div>


            <div class="k-edit-label  w-800-l">
                <label for="writeTime">创建日期</label>
            </div>
            <div data-container-for="writeTime" class="k-edit-field w-800-r">
               <input type="text" id="writeTime_inp" class="k-input k-textbox " name="writeTime" data-bind="value:writeTime">
            </div>

           

        </script>


<script>

 $(function () {
                window.appd;
     
                var DataHost = window.DataHost,
                    dataSource = new kendo.data.DataSource({
                        type: "json",
                        serverPaging: true,
                        serverSorting: true,
                        batch: true,
                        pageSize: 15,
                        serverFiltering:true,
                        transport: {
                            read:  {
                                url: DataHost + "/manger/voteItem/read",
                                type: "post"
                            },
                            update: {
                                url: DataHost + "/manger/voteItem/update",
                                type: "post",
                                complete: function(e) {
                                            $("#grid").data("kendoGrid").dataSource.read(); 
                                    }
                            },
                             destroy: {
                                url: DataHost + "/manger/voteItem/destroy",
                                type: "post"
                            },
                            create: {
                                url:DataHost + "/manger/voteItem/create",
                                type: "post",
                                complete: function(e) {
                                            $("#grid").data("kendoGrid").dataSource.read(); 
                                    }
                            }
                        },
                        schema: {
                            total: "Total",
                            data: "Data",
                            model: {
                                id:"_id",
                                fields: {
                                    "_id": { editable: false },
                                    "appId":{ editable: true },
                                    "voteId":{ editable: true },
                                    "groupId":{ editable: true },

                                    "title": { editable: true },
                                    "pictureThumb": { editable: true },
                                    "picture": { editable: true },
                                    "sex": { editable: true, type: "number"}, 
                                    "age": { editable: true, type: "number"}, 
                                    "number": { editable: true},
                                    "desc": { editable: true},
                                    "desc2": { editable: true}, 

                                    "todayVoteNumber": { editable: true, type: "number"}, 
                                    "lastdayVoteNumber": { editable: true, type: "number"}, 
                                    "lastdayVoteOrder": { editable: true, type: "number"}, 
                                    "isFreez": { editable: true, type: "number"}, 
                          
                                    "code1": { editable: true },
                                    "code2": { editable: true },
                                    "code3": { editable: true },
                                    "code4": { editable: true },

                                    "totalCount": { editable: false },
                                    
                                    "isShow": { editable: true, type: "number"},
                                    "writeTime": {editable: true, type: "date" },
                                }
                            }
                        }
                    });


                var toolbarAry = [];
                var commandAry = [];
                var toolbarAry = [
                        { name: "create", text: "添加被投票人" }
                        ]
if(!window.vote_hide){ 
    var zoneTitle = '所属分组'
 }else{
    var zoneTitle = '所属地区'
 }                             

        
                    var commandAry = [
                                { name: "edit", text: {edit: "编辑", update: "确定",  cancel: "取消"} },
                                { name: "destroy", text: "删除"},
                              ]


$.post('/manger/app/getList',{},function(data_ary){
                var d = []
                data_ary.forEach(function(v){
                    d.push({
                        text: v.appName, 
                        value:v._id
                    })
                })

                window.appd = d;

$.post('/manger/vote/getList',{},function(data_ary){
                var d2 = []
                data_ary.forEach(function(v){
                    d2.push({
                        text: v.title, 
                        value:v._id
                    })
                })

                window.voted = d2;


$.post('/manger/voteGroup/getList',{},function(data_ary){
                var d3 = []
                data_ary.forEach(function(v){
                    d3.push({
                        text: v.title, 
                        value:v._id
                    })
                })

                window.vote_group = d3;




                $("#grid").kendoGrid({
                    dataSource: dataSource,
                    pageable: true,
                    height: 700,
                    toolbar: toolbarAry,
                    columns: [
                        {
                            field:'_id',
                            title:'被投票项Id',
                            hidden:true,
                            hidden:window.vote_hide||false
                        },
                        { 
                            field: "appId",
                            title: "开发商",
                            values: d,
                            hidden:window.vote_hide||false
                        },
                        { 
                            field: "voteId",
                            title: "所属投票",
                            values: d2,
                            hidden:window.vote_hide||false
                        },
                        {

                            field: "groupId",
                            title: zoneTitle,
                            values: d3
                        },
                        { 
                            field: "title",
                            title: "姓名"
                        },                     
                        { 
                            field: "pictureThumb",
                            title: "缩略图",
                            template: "<img src='#=pictureThumb#' width=50 height=50/>",
                            //hidden:true
                        },
                        { 
                            field: "picture",
                            title: "大图",
                            hidden:true
                        },
                        { 
                            field: "sex",
                            title: "性别",
                            values:window.sex_ary,
                            hidden:true
                      
                        },
                        { 
                            field: "age",
                            title: "年龄",
                            hidden:true
                        },

                        { 
                            field: "number",
                            title: "工号",
                            hidden:true
                        },

                        { 
                            field: "desc",
                            title: "简介",
                            hidden:true
                        },
                        { 
                            field: "desc2",
                            title: "描述",
                            hidden:true
                        },
                        { 
                            field: "totalCount",
                            title: '总票数', 
                            filterable:false
                        },
                        { 
                            field: "todayVoteNumber",
                            title: "今日票数",
                            hidden:true
                        },
                        { 
                            field: "lastdayVoteNumber",
                            title: "昨日票数",
                            hidden:true
                        },
                        { 
                            field: "lastdayVoteOrder",
                            title: "昨日排名",
                            hidden:true
                        },
                        { 
                            field: "isFreez",
                            title: "是否冻结",
                            values:window.is_freeze
                        },
                        { 
                            field: "code1",
                            title: "作弊警告",
                            hidden:window.vote_hide||false
                         },
                         { 
                            field: "code2",
                            title: "备用字段2", 
                            hidden:true
                         },
                         { 
                            field: "code3",
                            title: "备用字段3", 
                            hidden:true
                         },
                         { 
                            field: "code4",
                            title: "备用字段4", 
                            hidden:true
                         },
                        { 
                            field: "isShow",
                            title: "是否启用", 
                            values:window.is_show_array
                        },                   
                        { 
                            field: "writeTime",
                            title: "创建日期",
                            format: "{0: yyyy-MM-dd HH:mm:ss}",
                            hidden:true
                        },
                        { command: commandAry, title: "&nbsp;", width: "160px" }],
                        filterable:window.filter_obj,
                    editable: {
                        confirmation:'确定删除吗？',
                        mode:"popup",
                        template: kendo.template($("#popup_editor").html()),
                        window : {
                                title: "添加/修改",
                                width:800,
                            }
                        },
                    edit:function(e){
                        $('.k-window-content').addClass('w-800-content');
                        $('.k-edit-form-container').addClass('w-800-content');
                    
                        $('#groupIdText').html(zoneTitle)

                        multiUpload($("#upload_file"), $('#appPicture_inp'), 1)
                        multiUpload($("#upload_file2"), $('#appPicture_inp2'), 1)
                        
                        window.dropdown_init($("#sex_inp"), window.sex_ary)
                        window.dropdown_init($("#isFreez_inp"), window.is_freeze)




                        window.dropdown_init($("#appId_inp"), d)
                        window.dropdown_init($("#voteId_inp"), d2, function(){
                            setTimeout(function(){
                                var v = $("#voteId_inp").val();
                                changeVote(v)
                            },100)
                            
                        })


                        var voteid = $.trim($("#voteId_inp").val())

                        var hasInit = false;
                        var changeVote = function(vid){
                            

                            $.post('/manger/voteGroup/getList',{voteid:vid},
                                function(data_ary){
                                    var d4 = []
                                    data_ary.forEach(function(v){
                                        d4.push({
                                            text: v.title, 
                                            value:v._id
                                        })
                                    })
                                    if(!hasInit){
                                        window.dropdown_init($('#groupId_inp'),d4)
                                        hasInit = true;
                                    }
                                    else{
                                        d4.unshift({
                                            text: '请选择', 
                                            value:''
                                        })
                                        var dropdownlist = $("#groupId_inp").data("kendoDropDownList");
                                        dropdownlist.setDataSource(d4)
                                        $("#groupId_inp").val('')
                                        
                                    }

                                                                    
                                    
                                })
                        }

                        if(voteid){        
                            changeVote(voteid)
                        }
                        else{
                            window.dropdown_init($('#groupId_inp'),window.not_sel)
                        }
                        


                         $('#writeTime_inp').kendoDateTimePicker();
         
                         
                            
                         $("#intro").kendoEditor({
                                tools: window.editor_tools,
                                messages: window.editor_messages
                         });
                         $("#intro2").kendoEditor({
                                tools: window.editor_tools,
                                messages: window.editor_messages
                         });  

                          window.dropdown_init()

                    }
                    
                });
        
        })
    })         
                                    
});
})









</script>
<% include inc/foot %>
