<!DOCTYPE>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=0.67,maximum-scale=0.67,user-scalable=no;"/>
<meta name="apple-touch-fullscreen" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no">


<title>景瑞御江山-全城派红包</title>
<link href="http://wzzy2014skin.qiniudn.com/yjs_zp2014activity-style.css" rel="stylesheet" type="text/css">
<script src="http://libs.baidu.com/jquery/1.9.0/jquery.min.js" type="text/javascript"></script>
<script src="http://wzhfile.qiniudn.com/jquery.cookie.js"  type="text/javascript"></script>
<script src="http://wzhfile.qiniudn.com/moment.js" type="text/javascript"></script>


<%- newrelic.getBrowserTimingHeader() %>
</head>
<style type="text/css">
<% if(timeError==1){%>
	.timeErrorHide{
		display: none !important;
	}
<%}%>
.activity-lottery-winning .main{
	background: url("http://wzzy2014skin.qiniudn.com/yjs_zp2014bg2.jpg") no-repeat top center;
}


.body_wrap{
	height: 788px;
	overflow: hidden !important;
}
.main{
	height: 788px !important;
}
#noprize{
	background: url("http://bcs.duapp.com/xytimg/yjszp%2F3.jpg") no-repeat center 0;
	background-size: 480px 720px;
}
#prizebox{
	background: url("http://bcs.duapp.com/xytimg/yjszp%2F2.jpg") no-repeat center 0;
	background-size: 480px 720px;
}
#mobile{
	background: url("http://wzzy2014skin.qiniudn.com/yjs_zp20141.jpg") no-repeat center 0;
	background-size: 480px 720px;
}
.question{
	padding: 20px 0 !important;
	width: 480px !important;
	height: 720px !important;
}
.share{
	margin-top: 430px !important;
}
.mobile_inp{
top: 361px;
left: 98px;
width: 290px;
height: 55px;
font-size: 18px;

}
.openBtn{
	margin-top: 395px !important;
}
.prize_num{
	top: 37px !important;
	left: 197px !important;
	font-size: 14px !important;
}
.bottom_tip{
	text-align: center;
	font-size: 13px;
	display: block;
	position: absolute;
	left: 0;
	bottom: 10px;
	width: 100%;
}
.bottom_tip a{
	color:#000;
}
</style>
<body>
<div class="body_wrap ">
<p class="bottom_tip">
<a href="http://xy-tang.com/index.html" target="_blank">
	信玉堂技术支持
</a>
</p>

<div class="main activity-lottery-winning" id="main" style="display:none;">
<div id="outercont">
<div id="outer-cont">
<div id="outer" style="-webkit-transform: rotate(2136deg);">
	<img src="http://wzzy2014skin.qiniudn.com/yjs_zp2014activity-lottery-1.png" width="432px"></div>
</div>
<div id="inner-cont">
<div id="inner">
	<img src="http://wzzy2014skin.qiniudn.com/yjs_zp2014activity-lottery-2.png">
</div>
</div>
</div>
<div class="content">
</div>

</div>



<div id="noprize" class="question" style="display:none;">
	<div class="question-title"></div>
	<div class="options button">
	    <ul></ul>
	  </div>
	<div class="share tools-button" onclick="mask();"></div>

</div> 
  
<div id="prizebox" class="question" style="display:none;">
	<div class="question-title"></div>
	<div class="options button">
	    <ul></ul>
	  </div>
	<div class="share tools-button" onclick="mask();"></div>
	
</div>
  
  
<div id="mobile" class="question"  style="display:none;">
	<div class="question-title"></div>
	<div class="options button">
	    <ul></ul>
	  </div>
	<!--<div id="prize_num" class="prize_num"></div>-->
	<div id="modify_info_btn" class="share tools-button openBtn" ></div>
	<input id="mobile_inp" class="mobile_inp" placeholder="请输入手机号码(仅限中国移动)" value="" maxlength="11">
</div>  
  
  
<div id="mask" class="mask_box" onclick="mask();"><img src="http://wzzy2014skin.qiniudn.com/wk_zp2014/guide.png"/></div> 
  
  
  
</div>
	
</div>





<script type="text/javascript">
var mask = function () {
		var maskObj = $('#mask');
		var tip = $('#tip');
		if(maskObj.is(':visible')){
			maskObj.hide();
			tip.hide();
		}
		else{
			maskObj.show();
			tip.show();
		}
}



window.isforward_today = moment().hour(23).minute(59).second(59)
window.isforward_today = new Date(window.isforward_today)

var forwardingUrl = 'http://mp.weixin.qq.com/s?sn=a4742fe33c341a7406901852cd040dcf&mid=201870933&idx=1&plg_auth=1&__biz=MjM5MDQwOTE2OA%3D%3D#rd';
var forwardingImg = 'http://wzzy2014skin.qiniudn.com/yjs_zp2014logo.jpg'
var forwardingTitle ='御江山全城送红包，赶紧来领一个'
var forwardingDesc ='御江山全城送红包，赶紧来领一个'
var forwardingCallback = function(){
	//10表示cookie设置有效期10天
	$.cookie('isForward', '1', { expires: 10, path: location.pathname });
	//location.href = location.href
}


$(function() {


var lotteryObj =  <%- JSON.stringify(lotteryObj) %>
var lotteryid = '<%= lotteryObj._id %>'
var userid = '<%= userid%>'
var appId = '<%= appId%>'
var u_username = '<%= wxuobj.appUserName %>'
var u_mobile = '<%= wxuobj.appUserMobile %>'
var appUserName = u_username
var appUserMobile = u_mobile 
var timeError = '<%= timeError %>'



window.hasPlay = false;
window.hasForwardPlay = false;


window.getIsForward = function(){
		var is_f = $.cookie('isForward')
		if(is_f == '0' || !is_f) return false
		return is_f
}


$.get('/lottery/<%= appEname%>/info?ename=<%= lotteryEname%>',{},function(d){
    if(d.error == 1){
      return alert(d.data)
    }
        window.lotteryData = d.data;

        //总限制数
        if(lotteryObj.forwardTimes>=0){
        	 var totalLimit = lotteryObj.intervalTimes + lotteryObj.forwardTimes
        }
        else{
        	var totalLimit = lotteryObj.intervalTimes
        }

        if(d.data.record && d.data.record.length > 0){
        	//获取当天的抽奖记录
        	var todayMoment = moment().hour(0).minute(0).second(0).millisecond(0);
        	var count = 0;
        	var countF = 0;
        	window.todayRecordList = d.data.record.filter(function(rObj){
        		//var rObjMoment = moment(rObj.writeTime)
        		//if(rObjMoment>=todayMoment){
        			if(rObj.isForward == 0){
        				count++
        			}
        			else if(rObj.isForward == 1){
        				countF++
        			}
        			return true;
        		//}
        		//return false;
        	})
        	if(window.todayRecordList.length>=totalLimit){
        		window.hasPlay = true;
        		window.hasForwardPlay = true;
        	}
        	else if(count<lotteryObj.intervalTimes && countF<lotteryObj.forwardTimes){
        		window.hasPlay = false;
        		window.hasForwardPlay = false
        	}
        	else if(count>=lotteryObj.intervalTimes && countF<lotteryObj.forwardTimes){
        		window.hasPlay = true;
        		window.hasForwardPlay = false;
        	}

        }

    },'json')


	var boxObjs = $('#mobile, #prizebox, #noprize, #main')





window.requestAnimFrame = (function() {
		return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
		function(callback) {
			window.setTimeout(callback, 1000 / 60)
		}
	})();


	var totalDeg = 360 * 3 + 0;
	var steps = [];
	var lostDeg = [260];
	var prizeDeg = [330, 135, 110, 60, 300, 210, 190, 40];
	//[50元，888左2元（不中），888元（不中），888右2元（不中），谢谢参与左2元（不中），谢谢参与右2元，100元，10元]
	var prize, sncode;
	var count = 0;
	var now = 0;
	var a = 0.01;
	var outter, inner, timer, running = false;
	function countSteps() {
		var t = Math.sqrt(2 * totalDeg / a);
		var v = a * t;
		for (var i = 0; i < t; i++) {
			steps.push((2 * v * i - a * i * i) / 2)
		}
		steps.push(totalDeg)
	}

	function step() {
		outter.style.webkitTransform = 'rotate(' + steps[now++] + 'deg)';
		outter.style.MozTransform = 'rotate(' + steps[now++] + 'deg)';
		if (now < steps.length) {
			requestAnimFrame(step)
		} else {
			running = false;
			setTimeout(function() {
							
					if(!window.prizeTitle){//没中奖
						alert(window.result)
						setTimeout(function(){
							boxObjs.hide();
							$('#noprize').show();
						},1000)
						
					}
					else{
						alert(window.result)
						
						setTimeout(function(){
							boxObjs.hide();
							$('#prize_num').html(prizeTitle.slice(0,-1))
							$('#mobile').show();
						},1000)
						
					}

			},
			200)
		}
	}


	function start(deg,haserror) {
		deg = deg || lostDeg[parseInt(lostDeg.length * Math.random())];
		running = true;
		clearInterval(timer);
		totalDeg = 360 * 5 + deg;
		steps = [];
		now = 0;
		countSteps();
		if(haserror){
			alert(window.result)
			return;
		}
		requestAnimFrame(step)
	}
	window.start = start;
	outter = document.getElementById('outer');
	inner = document.getElementById('inner');
	i = 10;
	$("#inner").click(function() {
		if (running) return;
		if (window.hasPlay && window.hasForwardPlay){
			alert('你已经玩过了，每人只能转一次哦');
			return
		}
		else if(window.hasPlay && !window.hasForwardPlay && !getIsForward()){
			alert('你已经玩过了，转发到朋友圈可以再玩一次哦');
			return			
		}

		//start(prizeDeg[0])
		//[50元，888左2元（不中），888元（不中），888右2元（不中），谢谢参与左2元（不中），谢谢参与右2元，100元，10元]
		//return;
		
		var q = {
			lotteryId:lotteryid
		}
		//如果正常机会已经用完了，并且有cookie，则用 isforward
		if(window.hasPlay && getIsForward()){
			q.isforward = 1
		}

		$.ajax({
			url: "/lottery/<%= appEname%>/start?ename=<%= lotteryEname%>",
			dataType: "json",
			type:'POST',
			data: q,
			beforeSend: function() {
				running = true;
				timer = setInterval(function() {
					i += 5;
					outter.style.webkitTransform = 'rotate(' + i + 'deg)';
					outter.style.MozTransform = 'rotate(' + i + 'deg)'
				},
				1)
			},
			success: function(d) {

					var prizeObj = {
						'50元':prizeDeg[0],
						'3元':prizeDeg[1],
						'888元':prizeDeg[2],
						'4元':prizeDeg[3],
						'5元':prizeDeg[4],
						'2元':prizeDeg[5],
						'100元':prizeDeg[6],
						'10元':prizeDeg[7]
					}
					//[50元，888左2元（不中），888元（不中），888右2元（不中），谢谢参与左2元（不中），谢谢参与右2元，100元，10元]

					if(d.error == 1){						
						window.prizeTitle = false;
						window.result = d.data;
						start(lostDeg[0],true);
						return;
					}  
					var prizeId = d.data.prizeId;
					if(prizeId == '0'){ //没有中奖
						window.prizeTitle = false;
						window.result = '很遗憾没有中奖哦';
						return start(lostDeg[0]);
					}

					var prizeTitle = d.data.prizeObj.name;
							//[50元，888左2元（不中），888元（不中），888右2元（不中），谢谢参与左2元（不中），谢谢参与右2元，100元，10元]
					var pos = prizeObj[prizeTitle]
					if(typeof pos == 'undefined'){
						window.prizeTitle = false;
						window.result = '您没有中奖哦';
						return start(lostDeg[0]);
					}
					
					window.prizeTitle = d.data.prizeObj.name;
					window.result = '恭喜您抽中'+window.prizeTitle
					window.lastRecordId = d.data.recordId.toString();
					start(pos);
					//console.log(window.prizeTitle)
				
			},
			error: function() {
				start(lostDeg[0]);
			},
			timeout: 5000
		})
	})

	

var mobile_num = ['139','138','137','136','135','134','159','150','151','158','157','188','187','152','182','147','183','184','170','178']
$('#modify_info_btn').click(function(){

    var appUserMobile = $('#mobile_inp').val().trim();

    if(!appUserMobile || !/^[0-9]{11}$/.test(appUserMobile)){
      alert('请输入正确的手机号码')
      return false;
    }
    var front3 = appUserMobile.slice(0,3);
    
    if(mobile_num.indexOf(front3) == -1){
    	alert('请输入移动号码')
      	return false;
    }
    

    $.post('/lottery/<%= appEname%>/complete',{
	    truename:u_username, 
	    mobile:appUserMobile,
	    recordId:window.lastRecordId,
    },function(d){
      if(d.error == 1) return alert(d.data);
      boxObjs.hide();
      $('#prizebox').show();
     
    },'json')
    return false;
	
})



	$('#main').show();
});












//移动开通
//139、138、137、136、135、134、159、150、151、158、157、188、187、152、182、147





</script>
<script src="/static/wx_share.js"></script>

<div style="display:none;">
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F4d70084ab8a23d1e8e76861a9553677d' type='text/javascript'%3E%3C/script%3E"));
</script>
</div>

</body>


</html>